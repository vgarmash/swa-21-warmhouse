@startuml
title Умный Дом (новое решение). Диаграмма сервиса телеметрии.

footer drawn with PlantUML v. %version() and C4-PlantUML v. C4Version()
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml
LAYOUT_LEFT_RIGHT()

!$ICONURL = "https://raw.githubusercontent.com/tupadr3/plantuml-icon-font-sprites/v3.0.0/icons"

!include $ICONURL/devicons/go.puml
!include $ICONURL/devicons/react.puml
!include $ICONURL/font-awesome-5/house_user.puml
!include $ICONURL/devicons2/influxdb_original.puml

Container_Boundary(device_service, "Сервис Телеметрии") {
    Component(api, "API", "Go")
    Component(telemetry_consumer, "Потребитель Телеметрии", "Go")
    Component(telemetry_service, "Сервис Телеметрии", "Go")
    ComponentDb(tsdb, "БД Телеметрии", "Хранение телеметрии с датчиков", $techn="Influx DB / Clickhouse", $sprite="influxdb_original")
}

Container(spa, "Портал пользователя", $techn="SPA", $sprite="react", $descr="SPA с микрофронтендами, обмен состоянием через Event Bus (шина событий)")
ContainerQueue(queue, "Брокер сообщений", $techn="MQTT")


Rel(spa, api, "Отправляет запросы в API для поиска и чтения метрик")
Rel(api, telemetry_service, "Перенаправляет запросы в сервис")

Rel(telemetry_service, tsdb, "Поиск, чтение метрик")
Rel(queue, telemetry_consumer, "Получение метрик от шлюза")
Rel(telemetry_consumer, tsdb, "Запись метрик в БД временных рядов")

@enduml