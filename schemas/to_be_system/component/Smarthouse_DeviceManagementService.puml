@startuml
title Умный Дом (новое решение). Диаграмма сервиса управления устройствами.

footer drawn with PlantUML v. %version() and C4-PlantUML v. C4Version()
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

!$ICONURL = "https://raw.githubusercontent.com/tupadr3/plantuml-icon-font-sprites/v3.0.0/icons"

!include $ICONURL/devicons/postgresql.puml
!include $ICONURL/devicons/go.puml
!include $ICONURL/devicons/react.puml
!include $ICONURL/font-awesome-5/users.puml
!include $ICONURL/font-awesome-5/house_user.puml


Container_Boundary(device_service, "Сервис Управления Устройствами") {
    Component(api, "API", "Go")

    Component(config_service, "Сервис Конфигурации", "Go")
    Component(scenario_service, "Сервис Сценариев", "Go")

    ComponentDb(db, "База данных", "Хранение данных о датчиках и устройствах", $techn="PostgreSQL", $sprite="postgresql")
    Component(command_producer, "Генератор комманд", "Go")
}

ContainerQueue(queue, "Брокер сообщений", $techn="MQTT")
Container(spa, "Портал пользователя", $techn="SPA", $sprite="react", $descr="SPA с микрофронтендами, обмен состоянием через Event Bus (шина событий)")



Rel(spa, api, "Отправляет запросы в API")
Rel(api, config_service, "Перенаправляет запросы в сервис")
Rel(api, scenario_service, "Перенаправляет запросы в сервис")

BiRel(config_service, queue, "Синхронизация конфигурации устройств с шлюзом")
Rel(config_service, queue, "Синхронизация команд с шлюзом")
Rel(command_producer, queue, "Отправка команд для устройств в шлюз")
Rel(scenario_service, queue, "Синхронизация сценариев с шлюзом")

Rel(config_service, db, "Чтение/Запись конфигурации")
Rel(scenario_service, db, "Чтение/Запись сценариев")
Rel(config_service, command_producer, "Генерация команд для устройств")
Rel(scenario_service, command_producer, "Запуск сценария по требованию пользователя")

@enduml