@startuml
title Умный Дом (новое решение). Диаграмма шлюза умного дома.

footer drawn with PlantUML v. %version() and C4-PlantUML v. C4Version()
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml
LAYOUT_LEFT_RIGHT()

!$ICONURL = "https://raw.githubusercontent.com/tupadr3/plantuml-icon-font-sprites/v3.0.0/icons"

!include $ICONURL/devicons/postgresql.puml
!include $ICONURL/devicons/go.puml
!include $ICONURL/devicons/react.puml
!include $ICONURL/font-awesome-5/users.puml
!include $ICONURL/font-awesome-5/house_user.puml

Person(users1, "Пользователи", "Пользователь дома", $sprite="users")

System_Boundary(hub1, "Шлюз умного дома", $descr="Управляет всеми устройствами и датчиками, исполняет сценарии, синхронизируется с облачной системой") {
    Component(spa, "UI шлюза", "React")
    Component(api, "API", "Java")
    Component(mqtt, "MQTT Client", "Java")
    Component(sensors_service, "Сервис датчиков", "Java", "Конфигурация и управление датчиками")
    Component(device_service, "Сервис устройств", "Java", "Конфигурация и управление датчиками")
    Component(scenario_service, "Сервис Сценариев", "Java", "Управление сценариями и их исполнение")
    Component(camera_service, "Сервис IP-Камер", "Java")
    ComponentDb(db, "База данных", "Хранилище конфигурации контроллера", $techn="SQLIte")
}
Boundary(wh, "Облако", "adf") {
    System_Boundary(SmartHomeCloud, "Система Умный Дом") {
        ContainerQueue(queue, "Брокер сообщений", $techn="MQTT")
        Container(media_service, "Медиа сервис", "Java, Media Server SDK", "Управление архивом видео и трансляция видеопотоков", $sprite="java")
    }
}
Rel(users1, spa, "Управляют шлюзом дома", "HTTP/JSON")
Rel(spa, api, "Перенаправляет запросы")
Rel(api, sensors_service, "")
Rel(api, device_service, "")
Rel(api, scenario_service, "")
Rel(api, camera_service, "")

Rel(sensors_service, db, "Чтение/Запись", "SQL")
Rel(device_service, db, "Чтение/Запись", "SQL")
Rel(scenario_service, db, "Чтение/Запись", "SQL")
Rel(camera_service, db, "Чтение/Запись", "SQL")

Rel(sensors_service, mqtt, "Отправка телеметрии")
Rel(device_service, mqtt, "Синхронизация конфигурации с облаком")
Rel(scenario_service, mqtt, "Синхронизация сценариев с облаком")
Rel(camera_service, mqtt, "Отправка телеметрии и событий")

Rel(camera_service, media_service, "видеопоток", "RTMP")

BiRel(mqtt, queue, "Обмен сообщениями с облачной системой", "JSON")
@enduml